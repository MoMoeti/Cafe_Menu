<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Café Menu v3.0</title>

  <!-- PWA MANIFEST (Installable App with YOUR LOGO) -->
  <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIkNhZsOpIE1lbnUgdjMuMCIsCiAgInNob3J0X25hbWUiOiAiQ2FmZSBNZW51IiwKICAic3RhcnRfdXJsIjogIi8iLAogICJpY29ucyI6IFt7CiAgICAic3JjIjogImh0dHBzOi8vaS5wb3N0aW1nLmNjL3BWOXA0UHRQLzEtcmVtb3ZlYmctcHJldmlldy5wbmciLAogICAgInNpemVzIjogIjE5MngxOTIiLAogICAgInR5cGUiOiAiaW1hZ2UvcG5nIgp9XSwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMTExIiwKICAidGhlbWVfY29sb3IiOiAiI2ZmMDAwMCIKfQ==">
  <meta name="theme-color" content="#ff0000">

  <style>
    /* ────────────────────── Global ────────────────────── */
    :root{
      --bg-color:#111;--text-color:#fff;--accent-color:red;
      --secondary-bg:#222;--input-bg:#333;--border-color:#444;
      --toggle-bg:#444;--toggle-hover:#666;
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    
    body{
      margin:0;font-family:Arial,sans-serif;color:var(--text-color);
      min-height:100vh;
      background: 
        linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)),
        url('https://i.postimg.cc/0NsfMgth/Food-Wallpaper-Backgrounds-Kitchens.jpg') center/cover no-repeat fixed;
      transition:background .5s ease;
    }
    body.light-mode{
      --bg-color:#fff;--text-color:#000;--secondary-bg:#eee;
      --input-bg:#f0f0f0;--border-color:#ccc;--toggle-bg:#ddd;--toggle-hover:#bbb;
      background: 
        linear-gradient(rgba(255,255,255,0.7), rgba(255,255,255,0.7)),
        url('https://i.postimg.cc/0NsfMgth/Food-Wallpaper-Backgrounds-Kitchens.jpg') center/cover no-repeat fixed;
    }

    /* ────────────────────── Header ────────────────────── */
    header{
      padding:20px;background:rgba(34,34,34,0.8);backdrop-filter:blur(10px);
      -webkit-backdrop-filter:blur(10px);display:flex;justify-content:space-between;
      align-items:center;position:sticky;top:0;z-index:100;
      border-bottom:1px solid var(--border-color);
    }
    body.light-mode header{background:rgba(255,255,255,0.9);border-bottom:1px solid #ddd;}
    
    header h1{
      margin:0;color:var(--accent-color);display:flex;align-items:center;gap:12px;font-size:1.4rem;
    }
    header h1 img{
      height:40px;width:auto;border-radius:8px;
    }
    button{cursor:pointer;border:none;padding:8px 12px;border-radius:8px;font-size:16px;transition:all .3s ease;}
    #modeToggle{background:var(--toggle-bg);color:var(--text-color);border-radius:50%;width:44px;height:44px;
                display:flex;align-items:center;justify-content:center;font-size:22px;}
    #modeToggle:hover{background:var(--toggle-hover);transform:scale(1.1);}
    #openImageBtn{background:var(--accent-color);color:white;border-radius:10px;font-weight:bold;}

    /* ────────────────────── Layout ────────────────────── */
    .container{padding:20px;max-width:1000px;margin:0 auto;}
    #menuSearch{width:100%;padding:12px;margin-bottom:20px;background:var(--input-bg);
                color:var(--text-color);border:none;border-radius:8px;font-size:16px;
                box-shadow:0 2px 5px rgba(0,0,0,.1);}
    #menuSearch:focus{outline:none;box-shadow:0 0 0 3px rgba(255,0,0,.3);}

    .category{margin-bottom:30px;}
    .category h2{color:var(--accent-color);border-bottom:2px solid var(--accent-color);
                 margin:0 0 12px;padding-bottom:5px;font-size:1.3rem;}
    .items-container{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:16px;}
    .item{display:flex;flex-direction:column;align-items:center;padding:10px;
          background:rgba(255,255,255,.1);border-radius:12px;
          transition:transform .2s ease,box-shadow .2s ease;
          backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);}
    body.light-mode .item{background:rgba(255,255,255,.7);}
    .item:hover{transform:scale(1.05);box-shadow:0 6px 15px rgba(0,0,0,.3);}
    .item-image{position:relative;cursor:pointer;width:100%;aspect-ratio:1;overflow:hidden;border-radius:10px;}
    .item-image img{width:100%;height:100%;object-fit:cover;}
    .item-info{position:absolute;bottom:0;left:0;right:0;
               background:rgba(0,0,0,0.75);color:#fff !important;
               padding:6px;text-align:center;font-size:14px;font-weight:500;
               display:flex;justify-content:space-between;align-items:center;
               border-bottom-left-radius:10px;border-bottom-right-radius:10px;}
    .item-info span:first-child{font-weight:bold;}
    .item-actions{display:flex;gap:6px;margin-top:8px;}
    .item-actions button{flex:1;padding:6px 8px;font-size:13px;border-radius:6px;}
    .item button.remove{background:#900;color:white;}
    .no-results{text-align:center;font-style:italic;color:var(--text-color);opacity:.7;margin:20px 0;}

    /* ────────────────────── CHECKOUT ────────────────────── */
    .checkout{background:rgba(34,34,34,0.9);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
              position:sticky;bottom:0;border-top:1px solid var(--border-color);
              border-radius:12px 12px 0 0;overflow:hidden;}
    body.light-mode .checkout{background:rgba(255,255,255,0.95);}
    .checkout-header{display:flex;justify-content:space-between;align-items:center;
                     cursor:pointer;padding:16px 20px;user-select:none;}
    .checkout-header h3{margin:0;color:var(--accent-color);font-size:1.2rem;}
    .toggle-icon{font-size:20px;transition:transform .3s ease;font-weight:bold;}
    .checkout-body{padding:0 20px 20px;max-height:1200px;overflow:hidden;
                   transition:max-height .4s cubic-bezier(.25,.8,.25,1), padding .35s cubic-bezier(.25,.8,.25,1);}
    .checkout-body.collapsed{max-height:0;padding-top:0;padding-bottom:0;}
    .checkout.collapsed .toggle-icon{transform:rotate(180deg);}
    .checkout input,.checkout textarea{width:100%;margin-top:12px;padding:12px;border:none;
                                      background:var(--input-bg);color:var(--text-color);font-size:16px;border-radius:8px;}
    .order-list{list-style:none;padding:0;margin:12px 0;}
    .order-list li{display:flex;justify-content:space-between;align-items:center;margin:6px 0;
                   padding:8px;background:rgba(255,255,255,.1);border-radius:6px;}
    body.light-mode .order-list li{background:rgba(0,0,0,.05);}
    .order-list button{background:#900;color:white;padding:4px 8px;border-radius:4px;}

    /* ────────────────────── Admin ────────────────────── */
    .admin{background:rgba(51,51,51,0.9);padding:20px;margin-top:20px;
           border-radius:12px;backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);}
    body.light-mode .admin{background:rgba(240,240,240,0.9);}
    .admin h3{color:var(--accent-color);margin-top:0;}
    .admin input,.admin textarea{width:100%;padding:10px;margin:6px 0;
                                 background:var(--secondary-bg);color:var(--text-color);
                                 border:none;border-radius:8px;font-size:16px;}
    .admin button{background:var(--accent-color);color:white;margin:6px 6px 6px 0;padding:10px 14px;border-radius:8px;}

    /* ────────────────────── Modals ────────────────────── */
    #imageModal,#posterPopup{display:none;position:fixed;top:0;left:0;width:100%;height:100%;
                             background:rgba(0,0,0,.9);justify-content:center;align-items:center;z-index:9999;}
    #imageModal img{max-width:95%;max-height:95%;border-radius:12px;touch-action:none;}
    #imageModal .closeBtn{position:absolute;top:15px;right:20px;color:white;
                          font-size:36px;font-weight:bold;background:rgba(0,0,0,.5);
                          border-radius:50%;width:50px;height:50px;display:flex;align-items:center;justify-content:center;}
    #posterPopup > div{position:relative;max-width:900px;margin:auto;background:var(--bg-color);
                       padding:20px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.5);}
    #posterPopup button{position:absolute;top:10px;right:10px;background:#900;color:white;padding:8px 12px;border-radius:50%;}
    .zoom-container{overflow:hidden;cursor:zoom-in;border-radius:12px;}
    .zoom-container img{width:100%;max-height:80vh;object-fit:contain;transition:transform .3s ease;}
    .zoom-container.zoomed img{transform:scale(2);cursor:zoom-out;}

    #confirm-box{color:#90ee90;font-weight:bold;padding:12px;margin:10px 0;
                 background:rgba(0,100,0,.2);border-radius:8px;text-align:center;}

    /* UPDATE BANNER */
    #updateBanner{display:none;background:#ff0;color:#000;padding:12px;text-align:center;font-weight:bold;
                  position:fixed;top:0;left:0;width:100%;z-index:9999;}
  </style>
</head>
<body>

  <!-- UPDATE BANNER -->
  <div id="updateBanner">
    New menu loaded! <button onclick="location.reload()" style="margin-left:10px;padding:5px 10px;">Refresh Now</button>
  </div>

  <!-- Header with LOGO -->
  <header>
    <h1>
      <img src="https://i.postimg.cc/pV9p4PtP/1-removebg-preview.png" alt="Café Logo">
      Café Menu (orderPad)
      <button id="openImageBtn" type="button">Open Menu</button>
    </h1>
    <button id="modeToggle" type="button" aria-label="Switch to light mode">Sun</button>
  </header>

  <!-- Image Modal -->
  <div id="imageModal">
    <span class="closeBtn" role="button" aria-label="Close modal">X</span>
    <img id="zoomImg" src="https://i.postimg.cc/7YHyLZ7B/IMG-20250807-WA0000.jpg" alt="Menu Poster">
  </div>

  <!-- Main Container -->
  <div class="container">
    <input type="text" id="menuSearch" placeholder="Search menu...">
    <div id="menu"></div>

    <!-- CHECKOUT -->
    <div class="checkout" id="checkoutPanel">
      <div class="checkout-header" onclick="toggleCheckout()" tabindex="0" role="button">
        <h3>Checkout</h3>
        <span class="toggle-icon" id="toggleIcon">Down Arrow</span>
      </div>
      <div class="checkout-body" id="checkoutBody">
        <ul class="order-list" id="orderList"></ul>
        <p>Order #: <span id="orderNumber"></span></p>
        <p>Total: R<span id="total">0</span></p>
        <input type="number" id="amountPaid" placeholder="Enter Amount Paid" min="0" step="0.01">
        <p>Change: R<span id="change">0</span></p>
        <textarea id="orderNotes" placeholder="Order Notes..." rows="3"></textarea>
        <button type="button" onclick="placeOrder()">Place Order</button>
        <button type="button" onclick="exportMenuToCSV()">Export Menu as CSV</button>
      </div>
    </div>

    <!-- Admin -->
    <div class="admin" id="adminSection" style="display:none;">
      <h3>Admin Panel</h3>
      <input type="text" id="itemName" placeholder="Item Name">
      <input type="number" id="itemPrice" placeholder="Item Price" min="0" step="0.01">
      <input type="text" id="itemCategory" placeholder="Category">
      <input type="text" id="itemImage" placeholder="Image URL (optional)">
      <button type="button" onclick="addItem()">Add Item</button>
      <button type="button" onclick="logoutAdmin()">Logout</button>
      <button type="button" onclick="exportSavedOrdersToCSV()">Export Saved Orders as CSV</button>
      <button type="button" onclick="clearSavedOrders()">Clear Saved Orders</button>
    </div>

    <div class="admin">
      <input type="password" id="adminPassword" placeholder="Enter Admin Password">
      <button type="button" onclick="loginAdmin()">Login</button>
    </div>

    <p id="confirm-box"></p>

    <!-- Poster Popup -->
    <div id="posterPopup" style="display:none;">
      <div>
        <button type="button" onclick="togglePoster()">Close</button>
        <div class="zoom-container" onclick="toggleZoom(this)">
          <img src="https://i.postimg.cc/7YHyLZ7B/IMG-20250807-WA0000.jpg" alt="Menu Poster">
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ────────────────────── v3.0 UPGRADE SYSTEM ────────────────────── */
    const APP_VERSION = "v3.0";
    const CACHE_NAME = `cafe-menu-${APP_VERSION}`;

    // Clear old caches
    if ('caches' in window) {
      caches.keys().then(names => {
        names.forEach(name => {
          if (name !== CACHE_NAME) caches.delete(name);
        });
      });
    }

    // Show update banner if version changed
    const savedVersion = localStorage.getItem("appVersion");
    if (savedVersion && savedVersion !== APP_VERSION) {
      document.getElementById("updateBanner").style.display = "block";
    }
    localStorage.setItem("appVersion", APP_VERSION);

    /* ────────────────────── PWA SERVICE WORKER ────────────────────── */
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('data:application/javascript;base64,' + btoa(`
          const CACHE = '${CACHE_NAME}';
          const FILES = ['/'];

          self.addEventListener('install', e => {
            e.waitUntil(caches.open(CACHE).then(c => c.addAll(FILES)));
            self.skipWaiting();
          });

          self.addEventListener('activate', e => {
            e.waitUntil(
              caches.keys().then(names => 
                Promise.all(names.filter(n => n !== CACHE).map(n => caches.delete(n)))
              )
            );
            self.clients.claim();
          });

          self.addEventListener('fetch', e => {
            e.respondWith(
              caches.match(e.request).then(r => r || fetch(e.request))
            );
          });
        `));
      });
    }

    /* ────────────────────── Constants & State ────────────────────── */
    const ADMIN_PASSWORD = "passedshit";
    const GOOGLE_SHEETS_ENDPOINT = "https://script.google.com/macros/s/AKfycbxsGJbsPttG2XK7yXPEF9Is81S5q3_5Hhot4-XhRu75Yy5t2ITxIWF_EpfsvNDc5ODv/exec";
    const WHATSAPP_NUMBER = "27694691709";

    let menu = JSON.parse(localStorage.getItem("menu")) || {
      Kotas: [
        { name: "Kota Cheese", price: 25, image: "https://i.postimg.cc/7YHyLZ7B/IMG-20250807-WA0000.jpg" },
        { name: "Kota Chicken", price: 30, image: "https://i.postimg.cc/7YHyLZ7B/IMG-20250807-WA0000.jpg" }
      ],
      Breakfast: [
        { name: "Egg Roll", price: 20, image: "https://i.postimg.cc/7YHyLZ7B/IMG-20250807-WA0000.jpg" },
        { name: "Full English", price: 45, image: "https://i.postimg.cc/7YHyLZ7B/IMG-20250807-WA0000.jpg" }
      ],
      "Add-ons": [
        { name: "Extra Cheese", price: 5, image: "https://i.postimg.cc/7YHyLZ7B/IMG-20250807-WA0000.jpg" },
        { name: "Chips", price: 15, image: "https://i.postimg.cc/7YHyLZ7B/IMG-20250807-WA0000.jpg" }
      ]
    };
    let order = [], currentOrderNumber = getNextOrderNumber();

    /* ────────────────────── Utils ────────────────────── */
    function getTodayDate(){return new Date().toISOString().split("T")[0];}
    function getNextOrderNumber(){
      const today = getTodayDate();
      const saved = localStorage.getItem("lastOrderDate");
      let n = parseInt(localStorage.getItem("orderNumber"))||1;
      if(today!==saved){n=1;localStorage.setItem("lastOrderDate",today);}
      localStorage.setItem("orderNumber",n+1);
      return n;
    }
    function saveOrderLocally(o){
      const a = JSON.parse(localStorage.getItem("savedOrders"))||[];
      a.push(o); localStorage.setItem("savedOrders",JSON.stringify(a));
    }

    /* ────────────────────── Menu Render ────────────────────── */
    function renderMenu(){
      const root=document.getElementById("menu"), q=document.getElementById("menuSearch").value.trim().toLowerCase(),
            admin=document.getElementById("adminSection").style.display==="block";
      root.innerHTML=""; let has=false;
      Object.keys(menu).forEach(cat=>{
        const items=menu[cat].filter(i=>i.name.toLowerCase().includes(q));
        if(!items.length) return;
        has=true;
        const sec=document.createElement("div"); sec.className="category"; sec.innerHTML=`<h2>${cat}</h2>`;
        const grid=document.createElement("div"); grid.className="items-container";
        items.forEach((it,idx)=>{
          const orig=menu[cat].indexOf(it);
          const div=document.createElement("div"); div.className="item";
          div.innerHTML=`
            <div class="item-image" onclick="addToOrder('${cat}',${orig})" role="button" aria-label="Add ${it.name}">
              <img src="${it.image}" alt="${it.name}" onerror="this.src='https://i.postimg.cc/7YHyLZ7B/IMG-20250807-WA0000.jpg'">
              <div class="item-info"><span>${it.name}</span><span>R${it.price.toFixed(2)}</span></div>
            </div>
            ${admin?`<div class="item-actions">
              <button type="button" onclick="editItem('${cat}',${orig})">Edit</button>
              <button type="button" class="remove" onclick="removeItem('${cat}',${orig})">Remove</button>
            </div>`:""}
          `;
          grid.appendChild(div);
        });
        sec.appendChild(grid); root.appendChild(sec);
      });
      if(!has){const d=document.createElement("div");d.className="no-results";d.textContent="No results found";root.appendChild(d);}
    }

    /* ────────────────────── Order ────────────────────── */
    function addToOrder(cat,idx){
      const it=menu[cat][idx];
      const ex=order.find(o=>o.name===it.name && o.price===it.price);
      ex?ex.quantity++:order.push({...it,quantity:1});
      updateOrder();
    }
    function removeFromOrder(idx){
      const it=order[idx];
      it.quantity>1?it.quantity--:order.splice(idx,1);
      updateOrder();
    }
    function updateOrder(){
      const tot=order.reduce((s,i)=>s+i.price*i.quantity,0);
      const paid=parseFloat(document.getElementById("amountPaid").value)||0;
      document.getElementById("total").textContent=tot.toFixed(2);
      document.getElementById("change").textContent=(paid-tot).toFixed(2);
      document.getElementById("orderNumber").textContent=currentOrderNumber;
      const ul=document.getElementById("orderList"); ul.innerHTML="";
      order.forEach((i,ix)=>{const li=document.createElement("li");
        li.innerHTML=`${i.name} - R${i.price.toFixed(2)} x ${i.quantity}
          <button type="button" onclick="removeFromOrder(${ix})">Remove</button>`;
        ul.appendChild(li);
      });
    }

    function placeOrder(){
      if(!order.length){alert("No items in the order.");return;}
      const notes=document.getElementById("orderNotes").value;
      const summary=order.map(i=>`${i.name} (R${i.price.toFixed(2)} x ${i.quantity})`).join(", ");
      const total=document.getElementById("total").textContent;
      const change=document.getElementById("change").textContent;
      const ts=new Date().toISOString();

      order.forEach(i=>{
        const data={timestamp:ts,orderNumber:currentOrderNumber,item:i.name,quantity:i.quantity,notes};
        sendToGoogleSheets(data); saveOrderLocally(data);
      });

      const msg=`*New Order #${currentOrderNumber}*:\n\nItems: ${summary}\nTotal: R${total}\nChange: R${change}\nNotes: ${notes}`;
      window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`,"_blank");

      order=[]; currentOrderNumber=getNextOrderNumber(); updateOrder();
      document.getElementById("orderNotes").value="";
    }

    /* ────────────────────── Admin ────────────────────── */
    function loginAdmin(){
      if(document.getElementById("adminPassword").value===ADMIN_PASSWORD){
        document.getElementById("adminSection").style.display="block";
        document.getElementById("adminPassword").value=""; renderMenu();
      }else alert("Incorrect password");
    }
    function logoutAdmin(){document.getElementById("adminSection").style.display="none";renderMenu();}
    function addItem(){
      const n=document.getElementById("itemName").value.trim(),
            p=parseFloat(document.getElementById("itemPrice").value),
            c=document.getElementById("itemCategory").value.trim(),
            i=document.getElementById("itemImage").value.trim();
      if(!n||isNaN(p)||p<0||!c){alert("Valid name, price & category required.");return;}
      if(!menu[c]) menu[c]=[];
      menu[c].push({name:n,price:p,image:i||undefined});
      localStorage.setItem("menu",JSON.stringify(menu)); renderMenu();
      document.getElementById("itemName").value=document.getElementById("itemPrice").value=
      document.getElementById("itemCategory").value=document.getElementById("itemImage").value="";
    }
    function editItem(cat,idx){
      const it=menu[cat][idx];
      const nn=prompt("Edit name:",it.name); if(nn===null) return;
      const np=prompt("Edit price:",it.price); if(np===null) return;
      const ni=prompt("Edit image URL (blank = keep):",it.image||"");
      const pr=parseFloat(np); if(isNaN(pr)||pr<0){alert("Invalid price.");return;}
      menu[cat][idx]={name:nn.trim(),price:pr,image:ni.trim()||it.image};
      localStorage.setItem("menu",JSON.stringify(menu)); renderMenu();
    }
    function removeItem(cat,idx){
      if(confirm("Remove this item?")){
        menu[cat].splice(idx,1);
        if(!menu[cat].length) delete menu[cat];
        localStorage.setItem("menu",JSON.stringify(menu)); renderMenu();
      }
    }

    /* ────────────────────── Export ────────────────────── */
    function exportMenuToCSV(){
      const rows=["Category,Item,Price,Image"];
      Object.keys(menu).forEach(c=>menu[c].forEach(i=>rows.push(`"${c}","${i.name}",${i.price.toFixed(2)},"${i.image||''}"`)));
      downloadCSV(rows.join("\n"),`menu_${getTodayDate()}.csv`);
    }
    function exportSavedOrdersToCSV(){
      const a=JSON.parse(localStorage.getItem("savedOrders"))||[];
      if(!a.length){alert("No saved orders.");return;}
      const keys=["timestamp","orderNumber","item","quantity","notes"];
      const csv=[keys.join(","),...a.map(o=>keys.map(k=>`"${String(o[k]).replace(/"/g,'""')}"`).join(","))].join("\n");
      downloadCSV(csv,`saved_orders_${getTodayDate()}.csv`);
    }
    function clearSavedOrders(){if(confirm("Clear all saved orders?")){localStorage.removeItem("savedOrders");alert("Cleared.");}}
    function downloadCSV(content,fn){
      const blob=new Blob([content],{type:"text/csv;charset=utf-8;"});
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a"); a.href=url; a.download=fn;
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    /* ────────────────────── Google Sheets ────────────────────── */
    function sendToGoogleSheets(o){
      const box=document.getElementById("confirm-box");
      box.textContent="Sending...";
      fetch(GOOGLE_SHEETS_ENDPOINT,{method:"POST",mode:"no-cors",
        headers:{"Content-Type":"application/json"},body:JSON.stringify(o)})
        .then(()=>{box.textContent="Saved to Google Sheets!";setTimeout(()=>box.textContent="",4000);})
        .catch(()=>{box.textContent="Failed.";setTimeout(()=>box.textContent="",5000);});
    }

    /* ────────────────────── Theme & UI ────────────────────── */
    function toggleTheme(){
      document.body.classList.toggle("light-mode");
      const btn=document.getElementById("modeToggle");
      btn.textContent=document.body.classList.contains("light-mode")?"Moon":"Sun";
    }

    function toggleCheckout(){
      const body=document.getElementById("checkoutBody"),
            panel=document.getElementById("checkoutPanel"),
            icon=document.getElementById("toggleIcon");
      body.classList.toggle("collapsed");
      panel.classList.toggle("collapsed");
      icon.textContent = body.classList.contains("collapsed") ? "Up Arrow" : "Down Arrow";
      localStorage.setItem("checkoutCollapsed",body.classList.contains("collapsed"));
    }

    function setupImageModal(){
      const modal=document.getElementById("imageModal"), img=document.getElementById("zoomImg");
      let scale=1,moveX=0,moveY=0,startX=0,startY=0,initDist=0;
      document.getElementById("openImageBtn").addEventListener("click",()=>{scale=1;moveX=moveY=0;img.style.transform="scale(1)";modal.style.display="flex";});
      document.querySelector("#imageModal .closeBtn").addEventListener("click",()=>{modal.style.display="none";});
      img.addEventListener("touchstart",e=>{
        if(e.touches.length===2){
          const dx=e.touches[0].clientX-e.touches[1].clientX;
          const dy=e.touches[0].clientY-e.touches[1].clientY;
          initDist=Math.hypot(dx,dy);
        }else if(e.touches.length===1){
          startX=e.touches[0].clientX-moveX; startY=e.touches[0].clientY-moveY;
        }
      });
      img.addEventListener("touchmove",e=>{
        e.preventDefault();
        if(e.touches.length===2){
          const dx=e.touches[0].clientX-e.touches[1].clientX;
          const dy=e.touches[0].clientY-e.touches[1].clientY;
          const dist=Math.hypot(dx,dy);
          scale*=dist/initDist; initDist=dist;
        }else if(e.touches.length===1){
          moveX=e.touches[0].clientX-startX; moveY=e.touches[0].clientY-startY;
        }
        img.style.transform=`scale(${scale}) translate(${moveX}px,${moveY}px)`;
      },{passive:false});
    }

    function togglePoster(){document.getElementById("posterPopup").style.display=
      document.getElementById("posterPopup").style.display==="none"?"block":"none";}
    function toggleZoom(el){el.classList.toggle("zoomed");}

    /* ────────────────────── Init ────────────────────── */
    document.getElementById("modeToggle").addEventListener("click",toggleTheme);
    document.getElementById("amountPaid").addEventListener("input",updateOrder);
    document.getElementById("menuSearch").addEventListener("input",renderMenu);
    document.getElementById("orderNumber").textContent=currentOrderNumber;

    // Restore checkout state
    document.addEventListener("DOMContentLoaded",()=>{
      const icon = document.getElementById("toggleIcon");
      if(localStorage.getItem("checkoutCollapsed")==="true"){
        document.getElementById("checkoutBody").classList.add("collapsed");
        document.getElementById("checkoutPanel").classList.add("collapsed");
        icon.textContent = "Up Arrow";
      } else {
        icon.textContent = "Down Arrow";
      }
      renderMenu(); setupImageModal();
    });
  </script>
</body>
</html>